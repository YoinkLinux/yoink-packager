#!/bin/bash

package_list=()
SKIP_CHECK=false
HAS_INSTALL=false
function check_file(){
    file="$1"
    { tar tvf "$file" .TREE ;} &> /dev/null
    tree_status=$?
    if [[ "$tree_status" -ne 0 ]]; then
        echo "Package $file does not have a .TREE file? What are you doing?"
	exit 1
    fi
    { tar tvf "$file" install.sh ;} &> /dev/null
    install_status=$?
    if [[ "$install_status" -eq 0 ]]; then
	HAS_INSTALL=true
    fi
}

run_install(){
	file="$1"
	echo "Found install script for $(basename $file)"
	[[ $HAS_INSTALL ]] && $(tar xf "$file" -O install.sh | bash)
}

function install_packages(){
    for package in "${package_list}"; do
        [[ ! $SKIP_CHECK = "true" ]] && check_file "$package"
        
	echo "Unpacking $(basename $package)"
        tar --dereference --exclude=.TREE --exclude=install.sh -xf $package -C /

	[[ $HAS_INSTALL = "true" ]] && run_install $package
	echo "Done."
    done
}

while [[ $# -gt 0 ]]; do
    opt="$1"
    shift;
    case "$opt" in
            "install")
                package_list=$@
                INSTALL=true
                break
                ;;
            "--skip-check")
                    SKIP_CHECK=true
                    ;;
            "extract")
                echo "Method stub."
                break
                ;;
            *)
                echo "Invalid option."
                exit 1
                ;;
    esac
done

[[ $INSTALL ]] && install_packages






